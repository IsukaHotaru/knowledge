# 浮点数类型存储规范

浮点数标准由IEEE 754标准指定. 根据该标准, 浮点数由三个部分组成: 符号位(S), 指数位(E), 尾数位(M). 其中, 符号位决定浮点数的正负性, 指数位用于表示浮点数的大小范围, 尾数位用于表示浮点数的精度.

表示公式为: $(-1)^{S} \times M \times 2^E$.
- $(-1)^S$表示符号位, $S=0$时为正, $S=1$时为负.
- $M$表示有效数字, 大于等于$1$, 小于$2$.
- $2^E$表示指数位.

如果$E$全0, 则代表该数为非规格数(subnormal number).

如果$E$全1, 则代表该数为特殊数(non-number).

如果$E$既非全0也非全1, 则代表该书为规格数(normal number).

## 32位浮点数(单精度)的存储方式

[单精度存储规范示意图](../resources/float.png)

最高位(第31位)为符号位$S$, 第30位到第23位为指数位$E$, 第22位到第0位为尾数位$M$.

IEEE 754规定, 指数位用于表示$[-127, 128]$范围内的指数. 为了表示更方便, 浮点型的指数位都有一个固定的偏移量$B$, 用于使$E + B = \text{非负整数}$, 这样指数位的部分就不需要为表示负数而担心了.

对于规格数来说, $E$的取值范围就是$[1, 254]$.

在32位浮点数存储中, $B=127$, 也就是如果运算得到的指数是$-127$, 那么在指数位中就表示为$E = -127 + B = 0$.

尾数位存储在$[1, 2)$范围内的数, 这种数形如$1.xxxxx...$, 将最高位的$1$隐藏, 然后在低位补零直到$23$位.

对于十进制浮点数$D$, 其实际存储流程就是:
1. 判断是否$D=0$, 如果是就直接令$F=0$.
2. 将$D$转化为二进制浮点数$D_b$.
3. 根据符号确定符号位$S$.
4. 将$D_b$向左或者向右移位到形如$1.xxx$, 并以向右移位为正, 向左移位为负, 记录位移数$\widetilde{E}$
5. 计算$E = \widetilde{E} + B$, 得到指数位, 这里$B=127$.
6. 将该$1.xxx$去掉开头的$1和小数点$, 并将$xxx$以低位补0的方式补到23位, 存储到$M$中.
7. 以$B -> E -> M$的顺序从高到低位存储, 即得到浮点数表示$F$.

对于从浮点数存储表示还原到值, 只需通过表示公式计算即可.

通过表示公式计算, 可以得到32位浮点数的取值范围(四舍五入后)是$$[-3.4\times10^{38}, -1.18\times10^{-38}]\cup [1.18\times10^{-38}, 3.4\times10^{38}]$$

但32位浮点数存储的有效数字只有**7位**. 因为真正存储原浮点数的有效位数只有尾数位的23位加上前面的1, 故一共可精确表示$2^{24}=16777216$个数字, 而$10^7 < 16777216 < 10^8$, 故32位浮点数存储有效数字为7位.

## 64位浮点数(双精度)的存储方式

原理同[32位浮点数](#32位浮点数单精度的存储方式), 区别是$E$扩展到11位, $B=1023$, 也就是指数位表示$[-1023, 1024]$, $M$扩展到52位.

64位浮点数的取值范围(四舍五入后)是$$[-1.8\times10^{308}, -4.9\times10^{-324}]\cup[4.9\times10^{-324}, 1.8\times10^{308}]$$

64位浮点数的有效数字是**16位**, 计算同32位浮点数.

## 非规格数 (以32位浮点数为例)

非规格数的作用是表示$0$和靠近$0$的数.

符号位$S$, 按原值确定.

指数位$E$, 全为0, 实际指数为$1-B=-126$.

尾数位前隐藏的整数部分是$0$而非$1$, 故表示的取值范围是$[0, 1)$.

根据表示公式, 非规格数的取值范围是$(-2^{-126}, 2^{-126})$. 而规格数的取值范围是$(-2^{128}, -2^{-126}] \cup [2^{-126}, 2^{128})$, 二者衔接, 正好表示$(-2^{128}, 2^{128})$.

## 特殊数 (以32位浮点数为例)

特殊数分为两种: 无穷和NaN

对于无穷, 符号位$S$可正可负, 指数位$E$全为1, 尾数位$M$全为0, 按照符号位分别记为-infinity和+infinity. 其表示所有超出规格数表示范围的数值.

而NaN表示计算出的值不是一个数值, 其符号位$S$可正可负, 指数位$E$全为1, 尾数位$M$不全为零即可, 仅仅标记一种特殊状态.